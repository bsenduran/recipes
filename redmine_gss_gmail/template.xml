<template xmlns="http://ws.apache.org/ns/synapse" name="SampleRecipe">
    <parameter name="redmine.username"/>
    <parameter name="redmine.password"/>
    <parameter name="redmine.statusId"/>
    <parameter name="redmine.assignedToId"/>
    <parameter name="redmine.password"/>
    <parameter name="gmail.username"/>
    <parameter name="gmail.oauthAccessToken"/>
    <parameter name="gmail.subject"/>
    <parameter name="gmail.to"/>
    <parameter name="googlespreadsheet.oauthConsumerKey"/>
    <parameter name="googlespreadsheet.oauthConsumerSecret"/>
    <parameter name="googlespreadsheet.oauthAccessToken"/>
    <parameter name="googlespreadsheet.oauthRefreshToken"/>
    <parameter name="googlespreadsheet.spreadsheetName"/>
    <parameter name="googlespreadsheet.worksheetName"/>

    <sequence>
        
        <log level="custom">
           <property name="TESTING333----" value="GMAIL HIT1" />
        </log>
        <redmine.init>
            <username>{get-property('func','redmine.username')}</username>
            <password>{get-property('func','redmine.password')}</password>
            <apiUrl>https://redmine.wso2.com</apiUrl>
            <responseType>xml</responseType>
        </redmine.init>
        <redmine.listIssues>
            <statusId>{get-property('func','redmine.statusId')}</statusId>
            <assignedToId>{get-property('func','redmine.assignedToId')}</assignedToId>
        </redmine.listIssues>
        <property name="cur_date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd')" scope="default"/>
        <iterate continueParent="true" preservePayload="true" attachPath="//issues" expression="//issues/issue">
            <target>
                <sequence>
                    <log level="custom">
                        <property name="TESTING1----" value="GMAIL HIT1" />
                    </log>
                    <property name="issue-id" expression="//issues/issue/id"/>
                    <property name="project-name" expression="//issues/issue/id/@name"/>
                    <property name="description" expression="//issues/issue/description"/>
                    <property name="due-date" expression="//issues/issue/due_date"/>
                    <script language="js"><![CDATA[
                        var current_date = mc.getProperty("cur_date").split("-");
                        //var due_date = mc.getProperty("due_date");
                        var due_date = "2014-12-12";
                        var email_content = "Please be noted following Redmine task assigned to has been due\n";
                        
                        print("HIT-----1");
                        if (due_date === null) {
                            mc.setProperty("is_due","false");
                            print("HIT-----2");
                        }
                        else{
                            var due_date_arr = due_date.split("-");
                            var due_date_obj = new Date(due_date_arr[0],due_date_arr[1],due_date_arr[2]);
                            var cur_date_obj = new Date(current_date[0],current_date[1],current_date[2]);
                            print("HIT-----3");

                            if ((cur_date_obj>due_date_obj)>0) {
                                print("HIT-----4");
                                mc.setProperty("is_due","true");
                                email_content+= "Project Name: " + mc.getProperty("project-name") + "\nIssue ID: " + mc.getProperty("issue-id") + "\nDescription: " + mc.getProperty("description");
                                mc.setProperty("email_content",email_content);
                            }
                            else {
                                print("HIT-----5");
                                mc.setProperty("is_due","false");
                            }
                        }
                    ]]></script>
                    <log level="custom">
                        <property name="TESTING-GMAIL1----" value="GMAIL HIT1" />
                    </log>
                    <gmail.init>
                        <username>{get-property('func','gmail.username')}</username>
                        <oauthAccessToken>{get-property('func','gmail.oauthAccessToken')}</oauthAccessToken>
                    </gmail.init>
                    <log level="custom">
                        <property name="TESTING-GMAI2L----" expression="get-property('is_due')" />
                    </log>
                    <filter source="get-property('is_due')" regex="true">
                        <then>
                            <log level="custom">
                                <property name="TESTING-GMAIL----" value="GMAIL HIT" />
                            </log>
                            <gmail.sendMail>
                                <subject>{get-property('func','gmail.subject')}</subject>
                                <toRecipients>{get-property('func','gmail.to')}</toRecipients>
                                <textContent>Your tasks are due</textContent>
                            </gmail.sendMail>
                        </then>
                    </filter>
                </sequence>
            </target>
        </iterate>
        <script language="js"><![CDATA[
            var current_date = mc.getProperty("cur_date").split("-");
            var issues = mc.getPayloadXML().issue;
            var returnCsv = "Issue_ID,Project_Name,Due_Date\n";
            var length = issues.length();

            for(i=0;i<length;i++) {
                var id = issues[i].id;
                var name = issues[i].project.@name;
                //var due_date = issues[i].due_date;
                var due_date = "2014-12-12";


                if (due_date != null) {
                    var due_date_arr = due_date.split("-");
                    var due_date_obj = new Date(due_date_arr[0],due_date_arr[1],due_date_arr[2]);
                    var cur_date_obj = new Date(current_date[0],current_date[1],current_date[2]);

                    if ((cur_date_obj>due_date_obj)>0) {
                        mc.setProperty("task_due","true");
                        returnCsv=returnCsv+id+","+name+","+due_date+"\n";
                    }
                    else {
                        mc.setProperty("task_due","false");
                    }
                }
            }

            mc.setPayloadXML(
                <text>{returnCsv}</text>
            );
            ]]>
        </script>
        <log level="full"/>
        <googlespreadsheet.oAuth2init>
            <oauthConsumerKey>{get-property('func','googlespreadsheet.oauthConsumerKey')}</oauthConsumerKey>
            <oauthConsumerSecret>{get-property('func','googlespreadsheet.oauthConsumerSecret')}</oauthConsumerSecret>
            <oauthAccessToken>{get-property('func','googlespreadsheet.oauthAccessToken')}</oauthAccessToken>
            <oauthRefreshToken>{get-property('func','googlespreadsheet.oauthRefreshToken')}</oauthRefreshToken>
        </googlespreadsheet.oAuth2init>
        <filter source="get-property('task_due')" regex="true">
            <then>
                <googlespreadsheet.importCSV>
                    <spreadsheetName>{get-property('func','googlespreadsheet.spreadsheetName')}</spreadsheetName>
                    <worksheetName>{get-property('func','googlespreadsheet.worksheetName')}</worksheetName>
                    <batchEnable>true</batchEnable>
                    <batchSize>10</batchSize>
                </googlespreadsheet.importCSV>
            </then>
        </filter>
    </sequence>
</template>
